<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Eye Normalizer</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4f46e5"> 

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        /* Ensure body and html are full height and allow scrolling */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body { 
            font-family: 'Inter', sans-serif;
            overflow-y: auto; /* Explicitly ensure vertical scrolling */
        }
    </style>
</head>
<body class="bg-gray-50 h-full overflow-y-auto p-4 sm:p-6">

    <div id="app" class="max-w-6xl mx-auto pb-12">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-indigo-700">AI Eye Normalizer & Enhancer</h1>
            <p class="text-gray-600 mt-2">Upload a portrait and use AI for advanced facial feature normalization and editing.</p>
        </header>

        <div class="bg-white p-6 rounded-xl shadow-2xl border border-gray-100">

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">1. Upload Image (Portrait Recommended)</label>
                <input type="file" id="imageInput" accept="image/*" class="w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-indigo-50 file:text-indigo-700
                    hover:file:bg-indigo-100"
                />
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="text-center">
                    <h3 class="font-medium text-gray-700 mb-2">Original Image Preview</h3>
                    <img id="originalPreview" class="w-full h-auto rounded-lg shadow-md object-contain max-h-96 bg-gray-100 p-2" src="https://placehold.co/400x400/eeeeee/333333?text=Upload+Image" alt="Original Image">
                    <button id="analysisButton" disabled class="mt-4 px-4 py-2 bg-purple-500 text-white font-semibold rounded-full shadow-md hover:bg-purple-600 transition duration-300 disabled:bg-purple-300 disabled:cursor-not-allowed">
                        Analyze Photo âœ¨
                    </button>
                </div>

                <div class="text-left">
                    <h3 class="font-medium text-gray-700 mb-2">AI Image Analysis</h3>
                    <div id="analysisOutput" class="h-64 overflow-y-auto p-4 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-600">
                        Upload an image and click "Analyze Photo âœ¨" to get a detailed description of the subject and scene.
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <label for="promptInput" class="block text-sm font-medium text-gray-700 mb-2">2. Editing Instruction</label>
                <textarea id="promptInput" rows="3" placeholder="Example: Normalize the damaged eye to look exactly like the healthy one."
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm resize-none"></textarea>
                <button id="refineButton" disabled class="mt-2 px-4 py-2 bg-fuchsia-500 text-white font-semibold rounded-full shadow-md hover:bg-fuchsia-600 transition duration-300 disabled:bg-fuchsia-300 disabled:cursor-not-allowed">
                    Refine Prompt âœ¨
                </button>
            </div>
            
            <div id="refinementOutput" class="mb-8 p-4 bg-yellow-50 border-l-4 border-yellow-400 text-sm text-gray-700 rounded-lg transition duration-300 ease-in-out hidden">
                <p class="font-semibold mb-2 text-yellow-800">Prompt Suggestions:</p>
                <ul id="refinementList" class="space-y-3"></ul>
            </div>

            <div class="mb-8">
                <button id="processButton" disabled class="w-full px-4 py-3 bg-indigo-500 text-white font-semibold text-lg rounded-xl shadow-lg hover:bg-indigo-600 transition duration-300 disabled:bg-indigo-300 disabled:cursor-not-allowed">
                    Run Normalization Edit
                </button>
            </div>

            <div id="loading" class="hidden text-center p-4">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-t-4 border-indigo-500 border-opacity-25 mr-3"></div>
                <span class="text-indigo-600 font-medium">Generating new image... This may take up to 30 seconds.</span>
            </div>

            <div id="results" class="mt-8 pt-6 border-t border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Results</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="text-center">
                        <h3 class="font-medium text-gray-600 mb-2">Input Image</h3>
                        <img id="inputFinal" class="w-full h-auto rounded-lg shadow-md object-contain max-h-96 bg-gray-100 p-2" src="https://placehold.co/400x400/eeeeee/333333?text=Original" alt="Original Image">
                    </div>
                    <div class="text-center">
                        <h3 class="font-medium text-gray-600 mb-2">Edited Image Output</h3>
                        <img id="editedImage" class="w-full h-auto rounded-lg shadow-md object-contain max-h-96 bg-gray-100 p-2" src="https://placehold.co/400x400/eeeeee/333333?text=Edited+Result" alt="Edited Image">
                        
                        <button id="downloadButton" disabled class="mt-4 px-6 py-2 bg-green-500 text-white font-semibold rounded-full shadow-md hover:bg-green-600 transition duration-300 disabled:bg-green-300 disabled:cursor-not-allowed">
                            Download Image
                        </button>
                    </div>
                </div>
            </div>

            <div id="messageBox" class="fixed bottom-4 right-4 bg-green-600 text-white p-3 rounded-lg shadow-xl hidden transition-opacity duration-300 text-sm">
                Copied to clipboard!
            </div>

        </div>
    </div>

    <script>
        // --- API Configuration ---
        const apiKey ="AIzaSyDr6KaKIpNXKJEn_5L1rl4VMhO9Eahhl8E"; // ðŸš¨ REQUIRED: Insert your Gemini API key here
        const IMAGE_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent";
        const TEXT_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";

        // --- DOM Elements ---
        const imageInput = document.getElementById('imageInput');
        const promptInput = document.getElementById('promptInput');
        const processButton = document.getElementById('processButton');
        const analysisButton = document.getElementById('analysisButton');
        const refineButton = document.getElementById('refineButton');
        const downloadButton = document.getElementById('downloadButton');
        const originalPreview = document.getElementById('originalPreview');
        const editedImage = document.getElementById('editedImage');
        const inputFinal = document.getElementById('inputFinal');
        const loading = document.getElementById('loading');
        const analysisOutput = document.getElementById('analysisOutput');
        const refinementOutput = document.getElementById('refinementOutput');
        const refinementList = document.getElementById('refinementList');
        const messageBox = document.getElementById('messageBox');


        // --- State ---
        let base64Image = null;
        let mimeType = null;
        const defaultPlaceholderText = "Upload an image and click 'Analyze Photo âœ¨' to get a detailed description of the subject and scene.";

        // --- Utility Functions ---

        /** Shows a temporary success message box */
        function showMessage(text) {
            messageBox.textContent = text;
            messageBox.classList.remove('hidden', 'opacity-0');
            messageBox.classList.add('opacity-100');
            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 300);
            }, 2000);
        }

        /** Copies text to clipboard and provides feedback */
        function copyToClipboard(text) {
            const tempInput = document.createElement('textarea');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            showMessage("Prompt copied!");
        }
        window.copyToClipboard = copyToClipboard; 


        /** Converts an image file to a Base64 string */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // Extract only the base64 part (data:image/jpeg;base64,...)
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        /** Generic fetch utility with exponential backoff for text generation */
        async function callGeminiTextApi(apiUrl, systemInstruction, userPrompt, imagePart = null) {
            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: userPrompt },
                        ...(imagePart ? [imagePart] : [])
                    ]
                }],
                config: {
                    systemInstruction: systemInstruction,
                }
            };
            
            let maxRetries = 5;
            let delay = 1000;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(`${apiUrl}?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                        return text;
                    } else if (response.status === 429) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    } else {
                        const errorData = await response.json();
                        console.error("Text API Error:", response.status, errorData);
                        throw new Error(`Text API failed with status ${response.status}`);
                    }
                } catch (error) {
                    console.error("Text API fetch failed:", error);
                    if (i === maxRetries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
            throw new Error("Text API failed after all retries.");
        }


        // --- Core Event Handlers ---

        function updateButtonState() {
            const hasImage = base64Image !== null;
            const hasPrompt = promptInput.value.trim().replace(/\s/g, '').length >= 10;
            const isEditedImageReady = editedImage.src && !editedImage.src.includes('Edited+Result') && !editedImage.src.includes('Processing');

            processButton.disabled = !(hasImage && hasPrompt);
            analysisButton.disabled = !hasImage;
            refineButton.disabled = !hasPrompt;
            downloadButton.disabled = !isEditedImageReady;
        }

        imageInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) {
                // reset state...
                base64Image = null;
                mimeType = null;
                const placeholder = "https://placehold.co/400x400/eeeeee/333333?text=Upload+Image";
                originalPreview.src = placeholder;
                editedImage.src = placeholder.replace('Upload+Image', 'Edited+Result');
                inputFinal.src = placeholder.replace('Upload+Image', 'Original');
                analysisOutput.innerHTML = defaultPlaceholderText;
                refinementOutput.classList.add('hidden');
                updateButtonState();
                return;
            }

            mimeType = file.type;
            const objectUrl = URL.createObjectURL(file);
            originalPreview.src = objectUrl;
            inputFinal.src = objectUrl;
            editedImage.src = "https://placehold.co/400x400/eeeeee/333333?text=Edited+Result";

            try {
                base64Image = await fileToBase64(file);
            } catch (error) {
                console.error("Error converting file to Base64:", error);
                base64Image = null;
                alert("Failed to read image file. Please try another file.");
            }
            updateButtonState();
        });

        promptInput.addEventListener('input', updateButtonState);
        editedImage.addEventListener('load', updateButtonState);


        // --- Feature 1: Image Analysis ---

        analysisButton.addEventListener('click', async () => {
            if (!base64Image || !mimeType) return;

            analysisButton.disabled = true;
            analysisButton.innerHTML = `<div class="inline-block animate-spin rounded-full h-4 w-4 border-2 border-t-2 border-white border-opacity-50 mr-2"></div> Analyzing...`;
            analysisOutput.innerHTML = `<span class="text-indigo-600">Analyzing image...</span>`;

            try {
                const systemPrompt = "You are a professional image analysis AI. Given an image, provide a concise, three-sentence description of the subject's appearance, including facial features, expression, and approximate lighting. State clearly which eye appears different or requires attention.";
                
                const imagePart = { inlineData: { mimeType: mimeType, data: base64Image } };
                const userPrompt = "Analyze this image and describe the subject, focusing on the eyes and any noticeable asymmetry or feature irregularity.";

                const analysisText = await callGeminiTextApi(TEXT_API_URL, systemPrompt, userPrompt, imagePart);
                
                analysisOutput.innerHTML = analysisText.replace(/\n/g, '<br>');

            } catch (error) {
                analysisOutput.innerHTML = `<span class="text-red-600">Error: Could not analyze photo. Check your API key and console.</span>`;
            } finally {
                analysisButton.innerHTML = `Analyze Photo âœ¨`;
                analysisButton.disabled = false;
                updateButtonState();
            }
        });

        // --- Feature 2: Prompt Refinement (with Copy Buttons) ---

        refineButton.addEventListener('click', async () => {
            if (refineButton.disabled) return;
            
            refineButton.disabled = true;
            refineButton.innerHTML = `<div class="inline-block animate-spin rounded-full h-4 w-4 border-2 border-t-2 border-white border-opacity-50 mr-2"></div> Refining...`;
            refinementOutput.classList.remove('hidden');
            refinementList.innerHTML = `<li class="text-fuchsia-600 list-none">Generating refined prompts...</li>`;


            try {
                const systemPrompt = "You are an expert prompt engineer for generative image editing models. The user wants to correct a facial feature in their photo. Given their current, possibly vague prompt, generate three specific, highly detailed, and effective alternative prompts that focus on achieving natural symmetry and correction of the eye(s). Output the three suggestions as a numbered list (1., 2., 3.) formatted in Markdown, and nothing else. DO NOT use markdown list syntax, use '1. ' '2. ' '3. ' format.";
                const userPrompt = `The user's current prompt is: "${promptInput.value.trim()}"`;

                const refinementResult = await callGeminiTextApi(TEXT_API_URL, systemPrompt, userPrompt);
                
                let prompts = refinementResult.split('\n')
                    .filter(line => line.match(/^\d+\./))
                    .map(line => line.replace(/^\d+\.\s*/, '').trim());

                if (prompts.length > 0) {
                    refinementList.innerHTML = prompts.map((prompt, index) => {
                        const escapedPrompt = prompt.replace(/'/g, "\\'").replace(/"/g, '\\"');
                        return `
                            <li class="flex justify-between items-start space-x-2">
                                <span class="flex-1 text-sm pt-1">${index + 1}. ${prompt}</span>
                                <button onclick="copyToClipboard('${escapedPrompt}')" class="flex-shrink-0 px-3 py-1 text-xs bg-fuchsia-100 text-fuchsia-700 font-semibold rounded-full hover:bg-fuchsia-200 transition duration-150">
                                    Copy
                                </button>
                            </li>
                        `;
                    }).join('');
                } else {
                    refinementList.innerHTML = `<li class="text-red-600 list-none">Could not generate suggestions. Try making your original prompt slightly longer.</li>`;
                }

            } catch (error) {
                refinementList.innerHTML = `<li class="text-red-600 list-none">Error: Could not refine prompt. Check your API key and console.</li>`;
            } finally {
                refineButton.innerHTML = `Refine Prompt âœ¨`;
                refineButton.disabled = false;
                updateButtonState();
            }
        });


        // --- Feature 3: Image Editing ---

        processButton.addEventListener('click', async () => {
            if (!base64Image || !mimeType) {
                console.error("Image or MIME type missing.");
                return;
            }

            // Disable button, show loading
            processButton.disabled = true;
            downloadButton.disabled = true;
            loading.classList.remove('hidden');
            editedImage.src = "https://placehold.co/400x400/eeeeee/333333?text=Processing...";
            
            const userPrompt = promptInput.value.trim();
            
            const systemPrompt = "You are an expert generative image editor specializing in facial feature normalization. Your task is to apply the user's editing instruction to the provided image, focusing on natural-looking corrections and maintaining the overall style and quality of the original photo. The goal is to achieve symmetry, particularly in the eye region, based on the prompt.";

            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: systemPrompt },
                        { text: userPrompt },
                        { inlineData: { mimeType: mimeType, data: base64Image } }
                    ]
                }]
            };

            try {
                const response = await fetch(`${IMAGE_API_URL}?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const result = await response.json();
                    const editedBase64 = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                    const editedMimeType = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.mimeType;

                    if (editedBase64 && editedMimeType) {
                        editedImage.src = `data:${editedMimeType};base64,${editedBase64}`;
                    } else {
                        throw new Error("API response did not contain the edited image data.");
                    }
                } else {
                    const errorData = await response.json();
                    console.error("Image API Error:", response.status, errorData);
                    throw new Error(`Image API failed with status ${response.status}`);
                }

            } catch (error) {
                console.error("Image editing failed:", error);
                editedImage.src = "https://placehold.co/400x400/ff4444/ffffff?text=Error!+Check+Console";
                alert("Image editing failed. Please check the console for details and ensure your API key is correct.");
            } finally {
                loading.classList.add('hidden');
                processButton.disabled = false;
                updateButtonState();
            }
        });

        // --- Download Functionality ---
        downloadButton.addEventListener('click', () => {
            if (downloadButton.disabled) return;

            const link = document.createElement('a');
            link.href = editedImage.src;
            link.download = 'normalized_eye_image.jpg';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // ðŸš¨ PWA ADDITION: Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Registering the service worker in the root scope
                navigator.serviceWorker.register('/sw.js') 
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
        // Initialize state on load
        document.addEventListener('DOMContentLoaded', updateButtonState);
    </script>
</body>

</html>

